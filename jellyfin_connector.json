{
  "id": "jellyfin",
  "name": "Jellyfin Connector (Salt Auth)",
  "version": "2025.11.23.20",
  "description": "Konektor s dvoufázovou autentizací (Salt + Hash) dle požadavku pro Streamlet.",
  "media": ["movies", "series"],
  "type": ["catalogues", "details", "stream"],
  "website": "https://github.com/klucon/jellyfin_connector",
  "author": "klucon, panzerman",
  "baseUrl": "http://{server}",
  "responseFormat": "json",

  "config": {
    "server": {
      "type": "string",
      "label": "Jellyfin Server (IP/URL)",
      "placeholder": "192.168.0.100:8096",
      "required": true
    },
    "useLogin": {
      "type": "boolean",
      "label": "Použít přihlášení (username + heslo)?",
      "default": true
    },
    "username": {
      "type": "string",
      "label": "Uživatelské jméno",
      "required": true
    },
    "password": {
      "type": "string",
      "label": "Heslo",
      "required": true
    }
  },

  "headers": {
    "X-Emby-Authorization": "MediaBrowser Client=\"Streamlet\", Device=\"Streamlet\", DeviceId=\"streamlet01\", Version=\"1.0.0\""
  },

  "auth": {
    "enabledIf": "{useLogin}",
    "steps": [
      {
        "name": "salt",
        "method": "POST",
        "url": "/salt/",
        "body": {
          "username_or_email": "{username}"
        },
        "response": {
          "storeAs": "salt",
          "path": "response.salt",
          "status": {
            "path": "response.code",
            "states": {
              "ok": "OK",
              "userNotFound": "SALT_FATAL_1"
            }
          }
        }
      },
      {
        "name": "login",
        "method": "POST",
        "url": "/login/",
        "body": {
          "username_or_email": "{username}",
          "password": "sha1(md5_crypt({password}, {salt}))",
          "keep_logged_in": "1"
        },
        "response": {
          "tokenPath": "response.token",
          "status": {
            "path": "response.code",
            "states": {
              "autherror": "LOGIN_FATAL_1"
            }
          }
        }
      }
    ],
    "storeTokenAs": "authToken"
  },

  "api": [
    {
      "name": "movies",
      "type": "catalogue_movies",
      "mediaType": "movie",
      "isHome": true,
      "method": "GET",
      // API call je upravena, aby nepoužívala {userId} a místo {apiKey} používá {authToken}
      "url": "/Items?IncludeItemTypes=Movie&Recursive=true&StartIndex={offset}&Limit=40&api_key={authToken}",
      "responseFormat": "json",
      "response": {
        "itemsKey": "Items",
        "mapping": {
          "id": "Id",
          "title": "Name",
          "rating": "CommunityRating",
          "poster": "Id"
        }
      },
      "imageBaseUrl": "http://{server}/Items/{id}/Images/Primary?api_key={authToken}"
    },

    {
      "name": "series",
      "type": "catalogue_series",
      "mediaType": "series",
      "isHome": true,
      "method": "GET",
      // API call je upravena, aby nepoužívala {userId} a místo {apiKey} používá {authToken}
      "url": "/Items?IncludeItemTypes=Series&Recursive=true&StartIndex={offset}&Limit=40&api_key={authToken}",
      "responseFormat": "json",
      "response": {
        "itemsKey": "Items",
        "mapping": {
          "id": "Id",
          "title": "Name",
          "rating": "CommunityRating",
          "poster": "Id"
        }
      },
      "imageBaseUrl": "http://{server}/Items/{id}/Images/Primary?api_key={authToken}"
    },
    {
      "name": "details",
      "type": "details",
      "mediaType": "movie",
      "method": "GET",
      "url": "/Items/{id}?api_key={authToken}",
      "responseFormat": "json",
      "response": {
        "mapping": {
          "id": "Id",
          "title": "Name",
          "overview": "Overview",
          "year": "ProductionYear",
          "genre": "Genres",
          "rating": "CommunityRating",
          "runtime": "RunTimeTicks"
        }
      },
      "imageBaseUrl": "http://{server}/Items/{id}/Images/Primary?api_key={authToken}"
    },
    {
      "name": "series_details",
      "type": "details",
      "mediaType": "series",
      "method": "GET",
      "url": "/Items/{id}?api_key={authToken}",
      "responseFormat": "json",
      "response": {
        "mapping": {
          "id": "Id",
          "title": "Name",
          "overview": "Overview",
          "year": "ProductionYear",
          "genre": "Genres",
          "rating": "CommunityRating"
        }
      },
      "imageBaseUrl": "http://{server}/Items/{id}/Images/Primary?api_key={authToken}"
    },
    {
      "name": "series_episodes",
      "type": "episodes",
      "mediaType": "series",
      "method": "GET",
      // Musí být upraveno, protože chybí {userId}
      "url": "/Items?IncludeItemTypes=Episode&ParentId={id}&SortBy=SortName&SortOrder=Ascending&Recursive=true&api_key={authToken}",
      "responseFormat": "json",
      "response": {
        "itemsKey": "Items",
        "mapping": {
          "id": "Id",
          "title": "Name",
          "overview": "Overview",
          "episode": "IndexNumber",
          "season": "ParentIndexNumber"
        }
      },
      "imageBaseUrl": "http://{server}/Items/{id}/Images/Primary?api_key={authToken}"
    },
    {
      "name": "stream",
      "type": "stream",
      "method": "GET",
      "url": "/Items/{id}/PlaybackInfo?api_key={authToken}",
      "responseFormat": "json",
      "response": {
        "itemsKey": "MediaSources",
        "mapping": {
          "url": "Path"
        }
      }
    }
  ]
}
